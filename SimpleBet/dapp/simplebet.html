<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Bet</title>
  </head>
  <body>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <div class="container">
      <form class="form-inline">
        <fieldset disabled>
          <div class="form-group">
            <label for="contractAddress" class="my-1 mr-2">Contract address</label>
            <input type="text" id="contractAddress" class="form-control" placeholder="">
          </div>
        </fieldset>
      </form>
      <br/><br/>

      <h2 id="placeBetDesc"></h2>
      <form class="form-inline" id="betForm">
	<div class="form-group">
            <label for="placeBetAmount" class="my-1 mr-2">I bet</label>
            <input type="text" class="form-control mb-2 mr-sm-2" id="placeBetAmount">
            <label class="my-1 mr-2" for="placeBetSelect">CMTs on</label>
            <select class="custom-select my-1 mr-sm-2" id="placeBetSelect">
            </select>
            <button id='placeBet' onclick="placeBet()" class="btn btn-primary my-1">Bet</button>
            <small id="placeBetResult" class="text-muted"></small>
	</div>
      </form>
      <br/><br/>

      <form class="form-inline" id="payForm">
	<div class="form-group">
            <label id="checkStatusResult" for="payMe"></label>
            <button id='payMe' onclick="payMe()" class="btn btn-primary my-1">Pay me</button>
            <small id="payMeResult" class="text-muted"></small>
	</div>
      </form>
    </div>

<script>
    var contract_addr = "0xfdf481e32b8162e7fd468cdc33a777d90715f087";
    $('#contractAddress').val(contract_addr);
    const betAbi = [
	{
		"constant": false,
		"inputs": [],
		"name": "terminate",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_game_desc",
				"type": "string"
			},
			{
				"name": "_number_of_choices",
				"type": "uint256"
			}
		],
		"name": "startGame",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_choice",
				"type": "uint256"
			}
		],
		"name": "placeBet",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "correct_choice",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_addr",
				"type": "address"
			}
		],
		"name": "checkStatus",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "correct_choice_txt",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "number_of_choices",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_correct_choice",
				"type": "uint256"
			},
			{
				"name": "_correct_choice_txt",
				"type": "string"
			}
		],
		"name": "endGame",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getAnswer",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "game_desc",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "payMe",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	}
    ];
    const contract = web3.cmt.contract(betAbi, contract_addr);
    const instance = contract.at(contract_addr);
    const userAddress = instance._eth.accounts[0];

    instance.game_desc(function (e, result) {
        if (e) {
            alert("The bet desc is not properly encoded");
        } else {
            var descs = result.split(";");
	    document.getElementById("placeBetDesc").innerHTML = descs[0];
            var selectList = document.getElementById("placeBetSelect");
            for (var i = 1; i < descs.length; i++) {
                var option = document.createElement("option");
                option.value = i - 1;
                option.text = descs[i];
                selectList.appendChild(option);
            }
        }
    });

    instance.checkStatus(userAddress, function (e, result) {
        console.log(result);
        var choice = 0;
        var amount = 0;
        var payout = 0;
        var paid = " ";
        if (result != null) {
            if (result[0] != null) {
                choice = result[0]
            }
            if (result[1] != null) {
                amount = result[1] / 1000000000000000000;
            }
            if (result[2] != null) {
                payout = result[2] / 1000000000000000000;
            }
            if (result[3] != null) {
                paid = Boolean(result[3]);
            }
            if (amount > 0) {
                document.getElementById("betForm").visibility = "hidden";
                document.getElementById("payForm").visibility = "visible";
                if (paid) {
                    document.getElementById("checkStatusResult").innerHTML = "You have already been paid:" + payout + " CMTs.";
                } else {
                    document.getElementById("checkStatusResult").innerHTML = "You bet " + amount + " CMTs on choice " + choice + ". The antipated payout is :" + payout + " CMTs";
                }
            } else {
                document.getElementById("betForm").visibility = "visible";
                document.getElementById("payForm").visibility = "hidden";
            }
        } else {
            // document.getElementById("checkStatusResult").innerHTML = e;
            document.getElementById("betForm").visibility = "visible";
            document.getElementById("payForm").visibility = "hidden";
        }
    });

    function placeBet() {
        var placeBetAmount = $('#placeBetAmount').val();
        var placeBetSelect = $('#placeBetSelect').val();
        var amount = Number(placeBetAmount);
        if (amount <= 0) {
            alert("The placeBet should bigger than 0");
            return;
        }
        console.log(amount);
        console.log(placeBetSelect);
        console.log(web3.toWei(amount, "cmt"));
        instance.placeBet(placeBetSelect, {
            value: web3.toWei(amount, "cmt"),
            gas: 3000000,
            gasPrice: 2000000000
        }, function (e, result) {
            console.log(result);
            if (result != null) {
                document.getElementById("placeBetResult").innerHTML = result;
            } else {
                document.getElementById("placeBetResult").innerHTML = "bet failed!";
            }
        });
    };

    function payMe() {
        var address = $('#address').val();
        var checkResult = "";
        var payout = " ";
        var paid = " ";
        instance.checkStatus(address, function (e, result) {
            console.log(result);
            if (result != null) {
                if (result[2] != null) {
                    payout = result[2] / 1000000000000000000;
                }
                if (result[3] != null) {
                    paid = Boolean(result[3]);
                }
                checkResult = result;
            }
        });
        console.log(checkResult);

        if (paid == true) {
            document.getElementById("payMeResult").innerHTML = "You had already been paid for amount:" + payout;
            return;
        }
        instance.payMe(function (e, result) {
            if (result != null) {
                document.getElementById("payMeResult").innerHTML = result;
            } else {
                document.getElementById("payMeResult").innerHTML = e;
            }
        });
    };
</script>
  </body>
</html>

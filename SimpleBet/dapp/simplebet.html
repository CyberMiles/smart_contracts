<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Bet</title>
</head>
<body>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<script>
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };
</script>
<script>
    var contract_addr = getUrlParameter('contract');
    const betAbi = [
        {
            "constant": false,
            "inputs": [],
            "name": "terminate",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "game_status",
            "outputs": [
                {
                    "name": "",
                    "type": "int8"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "correct_choice",
            "outputs": [
                {
                    "name": "",
                    "type": "int8"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [
                {
                    "name": "_addr",
                    "type": "address"
                }
            ],
            "name": "checkStatus",
            "outputs": [
                {
                    "name": "",
                    "type": "int8"
                },
                {
                    "name": "",
                    "type": "string"
                },
                {
                    "name": "",
                    "type": "int8"
                },
                {
                    "name": "",
                    "type": "uint256"
                },
                {
                    "name": "",
                    "type": "uint256"
                },
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "resumeGame",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "correct_choice_txt",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "number_of_choices",
            "outputs": [
                {
                    "name": "",
                    "type": "int8"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "stopGame",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "owner",
            "outputs": [
                {
                    "name": "",
                    "type": "address"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "getAnswer",
            "outputs": [
                {
                    "name": "",
                    "type": "int8"
                },
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "game_desc",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_correct_choice",
                    "type": "int8"
                },
                {
                    "name": "_correct_choice_txt",
                    "type": "string"
                }
            ],
            "name": "endGame",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "payMe",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_choice",
                    "type": "int8"
                }
            ],
            "name": "placeBet",
            "outputs": [],
            "payable": true,
            "stateMutability": "payable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "name": "_game_desc",
                    "type": "string"
                },
                {
                    "name": "_number_of_choices",
                    "type": "int8"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "constructor"
        }
    ];
    const contract = web3.cmt.contract(betAbi, contract_addr);
    const instance = contract.at(contract_addr);
    const userAddress = instance._eth.accounts[0];

    $(function () {
        var descs = [];
        var game_status = -1;
        var status_choice = 0;
        var status_amount = 0;
        var status_payout = 0;
        var status_paid = false;

        instance.checkStatus(userAddress, function (e, result) {
            console.log(result);
            if (result != null) {
                if (result[0] != null) {
                    game_status = result[0];
                }
                if (result[1] != null) {
                    descs = result[1].split(";");
                    document.getElementById("placeBetDesc").innerHTML = descs[0];
                    var selectList = document.getElementById("placeBetSelect");
                    for (var i = 1; i < descs.length; i++) {
                        var option = document.createElement("option");
                        option.value = i - 1;
                        option.text = descs[i];
                        selectList.appendChild(option);
                    }
                }
                if (result[2] != null) {
                    status_choice = Number(result[2]);
                }
                if (result[3] != null) {
                    status_amount = result[3] / 1000000000000000000;
                }
                if (result[4] != null) {
                    status_payout = result[4] / 1000000000000000000;
                }
                if (result[5] != null) {
                    status_paid = Boolean(result[5]);
                }

                console.log(descs);
                console.log(status_choice);
                console.log(descs[status_choice + 1]);

                if (game_status == 0) {
                    document.getElementById("alertTxt").style.visibility = "visible";
                    document.getElementById("alertTxt").innerHTML = "Betting has not started.";
                } else if (game_status == 2) {
                    document.getElementById("alertTxt").style.visibility = "visible";
                    document.getElementById("alertTxt").innerHTML = "Betting is paused.";
                } else if (game_status == 1) {
                    // the betting is ongoing
                    if (status_amount == 0) {
                        document.getElementById("placeBetButton").style.visibility = "visible";
                        document.getElementById("placeBetResult").innerHTML = "";
                    } else {
                        document.getElementById("placeBetResult").innerHTML = "You have already placed your bet of " + status_amount + " CMTs on " + descs[status_choice + 1] + ".";
                    }
                } else if (game_status == 3) {
                    // the betting has stopped
                    if (status_payout > 0 && status_paid) {
                        document.getElementById("payMeResult").innerHTML = "You bet " + status_amount + " CMTs on " + descs[status_choice + 1] + ". You already received your payout of: " + status_payout + " CMTs";
                    } else if (status_payout == 0) {
                        document.getElementById("payMeResult").innerHTML = "You bet " + status_amount + " CMTs on " + descs[status_choice + 1] + ". You have no anticipated payout.";
                    } else {
                        document.getElementById("payMeButton").style.visibility = "visible";
                        document.getElementById("payMeResult").innerHTML = "You bet " + status_amount + " CMTs on " + descs[status_choice + 1] + ". The antipated payout is :" + status_payout + " CMTs";
                    }
                } else {
                    document.getElementById("alertTxt").style.visibility = "visible";
                    document.getElementById("alertTxt").innerHTML = "There is an error!";
                }
            } else {
                document.getElementById("alertTxt").style.visibility = "visible";
                document.getElementById("alertTxt").innerHTML = "There is an error!";
            }
        });
    });

    function placeBet() {
        var placeBetAmount = $('#placeBetAmount').val();
        var placeBetSelect = $('#placeBetSelect').val();
        var amount = Number(placeBetAmount);
        if (amount <= 0) {
            alert("The placeBet should bigger than 0");
            return false;
        }
        console.log(amount);
        console.log(placeBetSelect);
        console.log(web3.toWei(amount, "cmt"));
        instance.placeBet(placeBetSelect, {
            value: web3.toWei(amount, "cmt"),
            gas: 3000000,
            gasPrice: 2000000000
        }, function (e, result) {
            console.log(result);
            if (result != null) {
                document.getElementById("placeBetButton").style.visibility = "hidden";
                document.getElementById("placeBetResult").innerHTML = "Success hash: " + result;
            } else {
                document.getElementById("placeBetResult").innerHTML = "bet failed!";
            }
        });
    }

    function payMe() {
        instance.payMe(function (e, result) {
            if (result != null) {
                document.getElementById("payMeButton").style.visibility = "hidden";
                document.getElementById("payMeResult").innerHTML = "Success hash: " + result;
            } else {
                document.getElementById("payMeResult").innerHTML = e;
            }
        });
    }
</script>

<div class="container">
    <br/><br/>
    <div id="alertTxt" class="alert alert-danger" role="alert" style="visibility:hidden"></div>
    <h1 id="placeBetDesc"></h1>
    <br/><br/>

    <form class="form-inline" id="betForm">
        <div class="form-group">
            <label for="placeBetAmount" class="my-1 mr-2">Step 1: I bet</label>
            <input type="text" class="form-control mb-2 mr-sm-2" id="placeBetAmount">
            <label class="my-1 mr-2" for="placeBetSelect">CMTs on</label>
            <select class="custom-select my-1 mr-sm-2" id="placeBetSelect">
            </select>
            <button style="visibility:hidden" id='placeBetButton' onclick="placeBet()" class="btn btn-primary my-1"
                    type="button">Bet
            </button>
            <small id="placeBetResult" class="text-muted">You cannot bet at this time or have already placed a bet.
            </small>
        </div>
    </form>
    <br/><br/>
    <hr/>

    <form class="form-inline" id="payForm">
        <div class="form-group">
            <label for="payMeButton" class="my-1 mr-2">Step 2: Get paid</label>
            <button style="visibility:hidden" id='payMeButton' onclick="payMe()" class="btn btn-primary my-1"
                    type="button">Pay me
            </button>
            <small id="payMeResult" class="text-muted">You will get paid after the game concludes and only if you win.
            </small>
        </div>
    </form>
</div>

</body>
</html>
